const { Client, GatewayIntentBits } = require("discord.js");
const express = require("express");

// Táº¡o client Discord
const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent
  ]
});

// LÆ°u tiá»n ngÆ°á»i chÆ¡i (reset khi restart)
const balances = {};

// Server giá»¯ bot sá»‘ng (Render + UptimeRobot)
const app = express();
app.get("/", (req, res) => res.send("Bot Ä‘ang hoáº¡t Ä‘á»™ng"));
app.listen(process.env.PORT || 3000);

// Khi bot online
client.once("ready", () => {
  console.log(`Bot Ä‘Äƒng nháº­p vá»›i tÃªn ${client.user.tag}`);
});

// Nháº­n tin nháº¯n
client.on("messageCreate", async (message) => {
  if (message.author.bot) return;

  const args = message.content.split(" ");
  const command = args[0].toLowerCase();

  // Náº¿u chÆ°a cÃ³ tiá»n thÃ¬ cho 1000
  balances[message.author.id] ??= 1000;

  // ğŸ’° XEM TIá»€N
  if (command === "!balance") {
    return message.reply(`ğŸ’° Sá»‘ dÆ° cá»§a báº¡n: **${balances[message.author.id]} coin**`);
  }

  // ğŸ² DICE â€“ ÄOÃN Sá»
  // !dice <tiá»n cÆ°á»£c> <1-6>
  if (command === "!dice") {
    const bet = parseInt(args[1]);
    const guess = parseInt(args[2]);

    if (!bet || bet <= 0)
      return message.reply("âŒ Tiá»n cÆ°á»£c khÃ´ng há»£p lá»‡.");

    if (!guess || guess < 1 || guess > 6)
      return message.reply("âŒ HÃ£y chá»n sá»‘ tá»« **1 Ä‘áº¿n 6**.");

    if (bet > balances[message.author.id])
      return message.reply("âŒ Báº¡n khÃ´ng Ä‘á»§ tiá»n.");

    const roll = Math.floor(Math.random() * 6) + 1;

    if (guess === roll) {
      balances[message.author.id] += bet * 5;
      message.reply(`ğŸ² Ra sá»‘ **${roll}** â€” ğŸ‰ Báº N THáº®NG!\n+${bet * 5} coin`);
    } else {
      balances[message.author.id] -= bet;
      message.reply(`ğŸ² Ra sá»‘ **${roll}** â€” ğŸ’€ Báº N THUA!\n-${bet} coin`);
    }
  }

  // ğŸª™ COIN FLIP
  // !cf <tiá»n cÆ°á»£c> heads/tails
  if (command === "!cf") {
    const bet = parseInt(args[1]);
    const choice = args[2]?.toLowerCase();

    if (!bet || bet <= 0)
      return message.reply("âŒ Tiá»n cÆ°á»£c khÃ´ng há»£p lá»‡.");

    if (!["heads", "tails"].includes(choice))
      return message.reply("âŒ Chá»n **heads** hoáº·c **tails**.");

    if (bet > balances[message.author.id])
      return message.reply("âŒ Báº¡n khÃ´ng Ä‘á»§ tiá»n.");

    const flip = Math.random() < 0.5 ? "heads" : "tails";

    if (choice === flip) {
      balances[message.author.id] += bet;
      message.reply(`ğŸª™ Káº¿t quáº£: **${flip}** â€” ğŸ‰ Báº N THáº®NG!`);
    } else {
      balances[message.author.id] -= bet;
      message.reply(`ğŸª™ Káº¿t quáº£: **${flip}** â€” ğŸ’€ Báº N THUA!`);
    }
  }

  // ğŸƒ BLACKJACK (tá»± Ä‘á»™ng)
  // !blackjack <tiá»n cÆ°á»£c>
  if (command === "!blackjack") {
    const bet = parseInt(args[1]);

    if (!bet || bet <= 0)
      return message.reply("âŒ Tiá»n cÆ°á»£c khÃ´ng há»£p lá»‡.");

    if (bet > balances[message.author.id])
      return message.reply("âŒ Báº¡n khÃ´ng Ä‘á»§ tiá»n.");

    const draw = () => Math.floor(Math.random() * 10) + 1;

    const player = draw() + draw();
    const dealer = draw() + draw();

    if (player > 21 || (dealer <= 21 && dealer >= player)) {
      balances[message.author.id] -= bet;
      message.reply(
        `ğŸƒ **BLACKJACK**\nBáº¡n: ${player}\nNhÃ  cÃ¡i: ${dealer}\nğŸ’€ Báº N THUA`
      );
    } else {
      balances[message.author.id] += bet;
      message.reply(
        `ğŸƒ **BLACKJACK**\nBáº¡n: ${player}\nNhÃ  cÃ¡i: ${dealer}\nğŸ‰ Báº N THáº®NG`
      );
    }
  }

  // âŒâ­• TIC TAC TOE (Ä‘Ã¡nh vá»›i bot)
  // !tictac <tiá»n cÆ°á»£c>
  if (command === "!tictac") {
    const bet = parseInt(args[1]);

    if (!bet || bet <= 0)
      return message.reply("âŒ Tiá»n cÆ°á»£c khÃ´ng há»£p lá»‡.");

    if (bet > balances[message.author.id])
      return message.reply("âŒ Báº¡n khÃ´ng Ä‘á»§ tiá»n.");

    const results = ["win", "lose", "draw"];
    const result = results[Math.floor(Math.random() * results.length)];

    if (result === "win") {
      balances[message.author.id] += bet;
      message.reply("âŒâ­• Báº N THáº®NG TicTacToe!");
    } else if (result === "lose") {
      balances[message.author.id] -= bet;
      message.reply("âŒâ­• Báº N THUA TicTacToe!");
    } else {
      message.reply("âŒâ­• HÃ’A â€” khÃ´ng máº¥t tiá»n.");
    }
  }
});

// ÄÄƒng nháº­p bot
client.login(process.env.TOKEN);
